{"componentChunkName":"component---gatsby-ghost-theme-src-templates-post-js","path":"/docker-private-registry-harbor-with-lets-encrypt","webpackCompilationHash":"283f27f644fa2f206251","result":{"data":{"post":{"html":"<p>Rolling your own Docker Private Registry might be necessary step if you don't want or can't use external resources. In this post I will describe Harbor as my favourite solution.</p>\n<p>There are several ways of creating Private Docker Registry, here are those which I've tested so far:</p>\n<ul>\n<li>Docker Registry + frontend UI</li>\n<li>Portus</li>\n<li>Harbor</li>\n</ul>\n<p>From all those options I've found Harbor the most completed and easiest to use solution.</p>\n<h2>Harbor + Let's encrypt</h2>\n<ol>\n<li>Issue a certificate with <code class=\"language-text\">docker-compose.get-letsencrypt.yml</code></li>\n<li>Install Harbor according to its installation guide (in <code class=\"language-text\">harbor.cfg</code> set cert files generated with Let's encrypt container)</li>\n<li>At this point Harbor service should work on specified URL with SSL encryption, please check it before going to the next step. In case of any issues I would advise to check containers logs if <code class=\"language-text\">docker logs ...</code> doesn't work use <code class=\"language-text\">sudo cat /var/log/harbor/[container-name].log</code></li>\n<li>Now it's time to setup SSL autorenewal using <strong>jwilder/nginx-proxy</strong> and <strong>jrcs/letsencrypt-nginx-proxy-companion</strong> (the most popular Let's encrypt Docker container)</li>\n</ol>\n<p>other option:</p>\n<p>Add something like:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">    # let&#39;s encrypt support\n    location /.well-known/acme-challenge/ {\n      proxy_pass http://le-nginx/.well-known/acme-challenge/;\n      proxy_set_header Host $$http_host;\n      proxy_set_header X-Real-IP $$remote_addr;\n      proxy_set_header X-Forwarded-For $$proxy_add_x_forwarded_for;\n\n      # When setting up Harbor behind other proxy, such as an Nginx instance, remove the below line if the proxy already has similar settings.\n      proxy_set_header X-Forwarded-Proto $$scheme;\n      proxy_buffering off;\n      proxy_request_buffering off;\n    }\n    # \\let&#39;s encrypt support</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>to nginx.conf file (it doesn't work as expected anyway).</p>\n<ol>\n<li>Create empty cert files (just to pass validation) with <code class=\"language-text\">touch</code> command</li>\n<li>Run <code class=\"language-text\">./prepare</code></li>\n<li>Remove generated blank cert files</li>\n<li>Start with <code class=\"language-text\">docker-compose up -d</code></li>\n<li>Wait several minutes to generate SSL certificate (you may track the progress with <code class=\"language-text\">docker logs -f le</code>)</li>\n<li>You are done! Go visit your SSL protected Private Docker Registry</li>\n</ol>\n<h2>Known issues</h2>\n<p>Some error messages which I manage to pass through.</p>\n<h3>[FATAL] [main.go:46]: failed to initialize the system: read /etc/adminserver/key: is a directory</h3>\n<p>Check your <strong>secretkey_path</strong> configuration in <strong>harbor.cfg</strong>. Probably you shouldn't change it or if you do (have to) remember about updating <strong>docker-compose.yml</strong> paths.\n<a href=\"https://github.com/vmware/harbor/issues/2208\">https://github.com/vmware/harbor/issues/2208</a></p>\n<h3>KeyError: u'host'</h3>\n<p>Check files inside <strong>common/templates</strong> directory. Probably you've tried to use some undefined variable inside one of the templates (it was <strong>$host</strong> in this case, which should be <strong>$$host</strong>).</p>\n<h2>Sources</h2>\n<p><a href=\"https://mtarnawa.org/2017/11/10/running-secured-private-docker-registry-nginx-proxy-letsencrypt/\">https://mtarnawa.org/2017/11/10/running-secured-private-docker-registry-nginx-proxy-letsencrypt/</a></p>","excerpt":"Rolling your own Docker Private Registry might be necessary step if you don't want or can't use external resources. In this post I willâ€¦","timeToRead":2,"rawMarkdownBody":"Rolling your own Docker Private Registry might be necessary step if you don't want or can't use external resources. In this post I will describe Harbor as my favourite solution.\n\nThere are several ways of creating Private Docker Registry, here are those which I've tested so far:\n\n- Docker Registry + frontend UI\n- Portus\n- Harbor\n\nFrom all those options I've found Harbor the most completed and easiest to use solution.\n\n## Harbor + Let's encrypt\n\n1. Issue a certificate with `docker-compose.get-letsencrypt.yml`\n2. Install Harbor according to its installation guide (in `harbor.cfg` set cert files generated with Let's encrypt container)\n3. At this point Harbor service should work on specified URL with SSL encryption, please check it before going to the next step. In case of any issues I would advise to check containers logs if `docker logs ...` doesn't work use `sudo cat /var/log/harbor/[container-name].log`\n4. Now it's time to setup SSL autorenewal using **jwilder/nginx-proxy** and **jrcs/letsencrypt-nginx-proxy-companion** (the most popular Let's encrypt Docker container)\n\nother option:\n\nAdd something like:\n```\n    # let's encrypt support\n    location /.well-known/acme-challenge/ {\n      proxy_pass http://le-nginx/.well-known/acme-challenge/;\n      proxy_set_header Host $$http_host;\n      proxy_set_header X-Real-IP $$remote_addr;\n      proxy_set_header X-Forwarded-For $$proxy_add_x_forwarded_for;\n\n      # When setting up Harbor behind other proxy, such as an Nginx instance, remove the below line if the proxy already has similar settings.\n      proxy_set_header X-Forwarded-Proto $$scheme;\n      proxy_buffering off;\n      proxy_request_buffering off;\n    }\n    # \\let's encrypt support\n```\nto nginx.conf file (it doesn't work as expected anyway).\n\n1. Create empty cert files (just to pass validation) with `touch` command\n2. Run `./prepare`\n3. Remove generated blank cert files\n4. Start with `docker-compose up -d`\n5. Wait several minutes to generate SSL certificate (you may track the progress with `docker logs -f le`)\n6. You are done! Go visit your SSL protected Private Docker Registry\n\n## Known issues\n\nSome error messages which I manage to pass through.\n\n### [FATAL] [main.go:46]: failed to initialize the system: read /etc/adminserver/key: is a directory\nCheck your **secretkey_path** configuration in **harbor.cfg**. Probably you shouldn't change it or if you do (have to) remember about updating **docker-compose.yml** paths.\nhttps://github.com/vmware/harbor/issues/2208\n\n### KeyError: u'host'\nCheck files inside **common/templates** directory. Probably you've tried to use some undefined variable inside one of the templates (it was **$host** in this case, which should be **$$host**).\n\n## Sources\n\nhttps://mtarnawa.org/2017/11/10/running-secured-private-docker-registry-nginx-proxy-letsencrypt/\n","frontmatter":{"author":"jan","feature_image":null,"title":"Docker Private Registry - Harbor with Let's encrypt","slug":"docker-private-registry-harbor-with-lets-encrypt","date":null,"tags":[],"date_created":"2018-01-19T22:12:45.000Z","date_updated":"2018-05-07T02:08:23.000Z","featured":false}},"similarPosts":{"edges":[]},"authors":{"edges":[{"node":{"id":"1","slug":"jan","name":"Jan Grzegorowski","bio":"Full-stack developer currently working with React / Java stack at Equinix","website":"","location":"","profile_image":{"relativePath":"avatar/photo-mini.jpg","childImageSharp":{"fixed":{"base64":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAUABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAUEAv/EABQBAQAAAAAAAAAAAAAAAAAAAAL/2gAMAwEAAhADEAAAAa8+nhDphjnIF7Ah/8QAGhAAAgMBAQAAAAAAAAAAAAAAAQIAAxEiMf/aAAgBAQABBQK5mUB762lg1VGvG8Udif/EABcRAQEBAQAAAAAAAAAAAAAAAAEQETH/2gAIAQMBAT8BAyHJ/8QAFhEAAwAAAAAAAAAAAAAAAAAAARAx/9oACAECAQE/ATUav//EABsQAQACAgMAAAAAAAAAAAAAAAECEgAQESAx/9oACAEBAAY/Agh64Wbx56u//8QAHBABAAIDAAMAAAAAAAAAAAAAAQARECExgaGx/9oACAEBAAE/IRAL6t4R+NaJW948RDMDnzHpQyxFZP/aAAwDAQACAAMAAAAQD8A8/8QAFhEBAQEAAAAAAAAAAAAAAAAAARAx/9oACAEDAQE/EGNZvP/EABYRAQEBAAAAAAAAAAAAAAAAAAEQMf/aAAgBAgEBPxBJGE//xAAcEAEBAAICAwAAAAAAAAAAAAABEQAhEDFRgcH/2gAIAQEAAT8Qfyh9bKr5wsWRAIpRh0prgVXZTPUxvgwCqwb+cGlgG6ILpxBXtz//2Q==","width":30,"height":30,"src":"/static/2b64da00e4a3f2952c8d9e3a6b631208/a6b89/photo-mini.jpg","srcSet":"/static/2b64da00e4a3f2952c8d9e3a6b631208/a6b89/photo-mini.jpg 1x,\n/static/2b64da00e4a3f2952c8d9e3a6b631208/74c3b/photo-mini.jpg 1.5x,\n/static/2b64da00e4a3f2952c8d9e3a6b631208/9c097/photo-mini.jpg 2x"}}},"profile_image_large":{"relativePath":"avatar/photo-mini.jpg","childImageSharp":{"fixed":{"base64":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAUABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAUEAv/EABQBAQAAAAAAAAAAAAAAAAAAAAL/2gAMAwEAAhADEAAAAa8+nhDphjnIF7Ah/8QAGhAAAgMBAQAAAAAAAAAAAAAAAQIAAxEiMf/aAAgBAQABBQK5mUB762lg1VGvG8Udif/EABcRAQEBAQAAAAAAAAAAAAAAAAEQETH/2gAIAQMBAT8BAyHJ/8QAFhEAAwAAAAAAAAAAAAAAAAAAARAx/9oACAECAQE/ATUav//EABsQAQACAgMAAAAAAAAAAAAAAAECEgAQESAx/9oACAEBAAY/Agh64Wbx56u//8QAHBABAAIDAAMAAAAAAAAAAAAAAQARECExgaGx/9oACAEBAAE/IRAL6t4R+NaJW948RDMDnzHpQyxFZP/aAAwDAQACAAMAAAAQD8A8/8QAFhEBAQEAAAAAAAAAAAAAAAAAARAx/9oACAEDAQE/EGNZvP/EABYRAQEBAAAAAAAAAAAAAAAAAAEQMf/aAAgBAgEBPxBJGE//xAAcEAEBAAICAwAAAAAAAAAAAAABEQAhEDFRgcH/2gAIAQEAAT8Qfyh9bKr5wsWRAIpRh0prgVXZTPUxvgwCqwb+cGlgG6ILpxBXtz//2Q==","width":60,"height":60,"src":"/static/2b64da00e4a3f2952c8d9e3a6b631208/9c097/photo-mini.jpg","srcSet":"/static/2b64da00e4a3f2952c8d9e3a6b631208/9c097/photo-mini.jpg 1x,\n/static/2b64da00e4a3f2952c8d9e3a6b631208/c5aad/photo-mini.jpg 1.5x"}}}}}]},"tags":{"edges":[]},"tagPosts":{"edges":[],"totalCount":0}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"docker-private-registry-harbor-with-lets-encrypt","tags":[],"author":"jan","mainTag":"","prev":{"frontmatter":{"slug":"babel-plugin-basics","tags":[],"author":"jan"}},"next":{"frontmatter":{"slug":"cross-domain-cookie-sharing","tags":[],"author":"jan"}}}}}